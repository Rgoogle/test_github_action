name: ğŸ§  å­¦ä¹  GitHub Actions æ ¸å¿ƒç”¨æ³• Demo

# ========== 1. è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨ + å®šæ—¶ + å¸¦è¾“å…¥å‚æ•° ==========
on:
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨åœ¨ç½‘é¡µä¸Šç‚¹å‡»è¿è¡Œ
    inputs:
      mode:           # è¾“å…¥å‚æ•°ï¼šé€‰æ‹©æ¨¡å¼
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        type: choice
        default: 'fast'
        options: ['fast', 'slow', 'debug']
      enable_feature:
        description: 'æ˜¯å¦å¯ç”¨æŸåŠŸèƒ½'
        type: boolean
        default: false
      custom_suffix:
        description: 'è‡ªå®šä¹‰åç¼€'
        type: string
        default: ''

# ========== 2. å…¨å±€ç¯å¢ƒå˜é‡ ==========
env:
  DEMO_VERSION: '1.0.0'
  DEFAULT_SUFFIX: 'learn-actions'

# ========== 3. å®šä¹‰ Job ==========
jobs:
  demo_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ğŸ‘ˆ å¿…é¡»åŠ è¿™ä¸€è¡Œï¼
    outputs:                          # å®šä¹‰ Job è¾“å‡ºï¼Œä¾›åç»­ Job ä½¿ç”¨
      final_mode: ${{ steps.set_mode.outputs.mode_name }}
      build_number: ${{ steps.generate_number.outputs.num }}

    steps:

      # --- 4. æœ€åŸºç¡€ï¼šè¿è¡Œ Shell å‘½ä»¤ ---
      - name: âœ… æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        run: |
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "è¿è¡Œåœ¨: ${{ runner.os }}"
          echo "è¾“å…¥å‚æ•° mode: ${{ github.event.inputs.mode }}"
          echo "å…¨å±€ç¯å¢ƒå˜é‡: ${{ env.DEMO_VERSION }}"

      # --- 5. æ¡ä»¶åˆ¤æ–­ if ---
      - name: ğŸš¦ æ ¹æ®è¾“å…¥å‚æ•°æ‰§è¡Œä¸åŒé€»è¾‘
        if: ${{ github.event.inputs.mode == 'fast' }}
        run: echo "ğŸš€ å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡è€—æ—¶æ­¥éª¤"

      - name: ğŸ¢ æ…¢é€Ÿæ¨¡å¼é¢å¤–æ­¥éª¤
        if: ${{ github.event.inputs.mode == 'slow' }}
        run: |
          echo "ğŸŒ æ…¢é€Ÿæ¨¡å¼ï¼šæ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡..."
          sleep 5
          echo "æ…¢é€Ÿä»»åŠ¡å®Œæˆ"

      # --- 6. è®¾ç½®ç¯å¢ƒå˜é‡ & Job è¾“å‡º ---
      - name: ğŸ§© åŠ¨æ€è®¾ç½®å˜é‡
        id: set_mode                    # è®¾ç½® step idï¼Œç”¨äºå¼•ç”¨è¾“å‡º
        run: |
          MODE="${{ github.event.inputs.mode }}"
          echo "å½“å‰æ¨¡å¼: $MODE"

          # è®¾ç½® Step è¾“å‡º (ç»™å½“å‰ Job çš„å…¶ä»– Step æˆ–åç»­ Job ç”¨)
          echo "mode_name=$MODE" >> $GITHUB_OUTPUT

          # è®¾ç½®ç¯å¢ƒå˜é‡ (å½“å‰ Job å†…åç»­ Step å¯ç”¨)
          echo "CURRENT_MODE=$MODE" >> $GITHUB_ENV

      # --- 7. ä½¿ç”¨ç¯å¢ƒå˜é‡ & è¡¨è¾¾å¼ ---
      - name: ğŸ“ ä½¿ç”¨åŠ¨æ€å˜é‡
        run: |
          echo "ä»ä¸Šä¸€æ­¥è·å–çš„æ¨¡å¼: ${{ steps.set_mode.outputs.mode_name }}"
          echo "ä»ç¯å¢ƒå˜é‡è·å–çš„æ¨¡å¼: ${{ env.CURRENT_MODE }}"

      # --- 8. æ•°å­¦è¿ç®— & å¤‡ç”¨å€¼ (||) ---
      - name: ğŸ”¢ ç”Ÿæˆæ„å»ºå·
        id: generate_number
        run: |
          # æ¨¡æ‹Ÿï¼šå¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼ 999
          BUILD_NUM=$(expr 100 + $(date +%s) % 100 2>/dev/null || echo 999)
          echo "æ„å»ºå·: $BUILD_NUM"
          echo "num=$BUILD_NUM" >> $GITHUB_OUTPUT

      # --- 9. å­—ç¬¦ä¸²æ ¼å¼åŒ– & é»˜è®¤å€¼ fallback ---
      - name: ğŸ·ï¸ ç”Ÿæˆæœ€ç»ˆåç§°
        run: |
          # å¦‚æœ custom_suffix ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ DEFAULT_SUFFIX
          SUFFIX="${{ github.event.inputs.custom_suffix || env.DEFAULT_SUFFIX }}"
          FINAL_NAME="demo-${{ env.DEMO_VERSION }}-${SUFFIX}-${{ steps.generate_number.outputs.num }}"
          echo "æœ€ç»ˆäº§ç‰©åç§°: $FINAL_NAME"

          # è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
          echo "ARTIFACT_NAME=$FINAL_NAME" >> $GITHUB_ENV

      # --- 10. åˆ›å»ºç›®å½• & æ¨¡æ‹Ÿç”Ÿæˆæ–‡ä»¶ ---
      - name: ğŸ“‚ åˆ›å»ºæ¨¡æ‹Ÿäº§ç‰©
        run: |
          mkdir -p ./output
          echo "Hello GitHub Actions!" > ./output/${{ env.ARTIFACT_NAME }}.txt
          echo "æ¨¡æ‹Ÿæ–‡ä»¶å·²åˆ›å»º: ./output/${{ env.ARTIFACT_NAME }}.txt"

      # --- 11. ä¸Šä¼ å·¥ä»¶ (Artifacts) ---
      - name: ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./output/

  # ========== 12. ç¬¬äºŒä¸ª Jobï¼Œä¾èµ–ç¬¬ä¸€ä¸ª Job ==========
  show_results:
    needs: demo_job                   # å¿…é¡»ç­‰ demo_job å®Œæˆ
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š æ˜¾ç¤ºä¸Šä¸€ä¸ª Job çš„ç»“æœ
        run: |
          echo "ğŸ‰ ä¸Šä¸€ä¸ª Job ä¼ é€’çš„æ¨¡å¼: ${{ needs.demo_job.outputs.final_mode }}"
          echo "ğŸ‰ ä¸Šä¸€ä¸ª Job ç”Ÿæˆçš„æ„å»ºå·: ${{ needs.demo_job.outputs.build_number }}"

      # --- 13. ä¸‹è½½ä¸Šä¸€ä¸ª Job ä¸Šä¼ çš„å·¥ä»¶ ---
      - name: ğŸ“¥ ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('demo-{0}-learn-actions-{1}', env.DEMO_VERSION, needs.demo_job.outputs.build_number) }}
          path: ./downloaded

      - name: ğŸ” æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶
        run: |
          ls -la ./downloaded/
          cat ./downloaded/*.txt

      # --- 14. æ¡ä»¶æ€§åˆ›å»º Release (ä»…å½“ä¸æ˜¯ debug æ¨¡å¼) ---
      - name: ğŸš€ åˆ›å»º Release (é Debug æ¨¡å¼)
        if: ${{ needs.demo_job.outputs.final_mode != 'debug' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.DEMO_VERSION }}-${{ needs.demo_job.outputs.build_number }}
          name: Release ${{ env.DEMO_VERSION }} (${{ needs.demo_job.outputs.final_mode }})
          body: |
            - æ„å»ºå·: ${{ needs.demo_job.outputs.build_number }}
            - æ¨¡å¼: ${{ needs.demo_job.outputs.final_mode }}
            - æ—¶é—´: ${{ github.event.created_at }}
          draft: false
